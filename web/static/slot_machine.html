<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Shark Win Slots</title>
    <link rel="stylesheet" href="/static/css/slot_machine.css">

</head>
<body>
    <div class="container">
        <h1>Shark Win Slots</h1>
        <div class="info">
            <p>Баланс: <span id="balance"><h2>{{ printf "%.2f" .Balance }} JPC</h2></span> USDT</p>
            <p>Free Spins: <span id="freespins">{{.FreeSpins}}</span></p>
            <p>Прогрессивный Джекпот: <span id="jackpot">{{ printf "%.2f" .Jackpot }}</span> USDT</p>
        </div>
        <div class="game">
            <div class="reels" id="reels">
                <div class="reel">?</div>
                <div class="reel">?</div>
                <div class="reel">?</div>
            </div>
            <div class="controls">
                <input type="number" id="bet" placeholder="Введите ставку (0.1-30)" min="0.1" max="30" step="0.1">
                <label>
                    <input type="checkbox" id="fs_mode"> Режим FreeSpin
                </label>
                <button id="spin">Вращать</button>
            </div>
            <div id="result"></div>
        </div>
        <div class="top-players">
            <h2>Топ-10 игроков</h2>
            <ul id="top-list"></ul>
        </div>
        <!-- Скрытый элемент для передачи telegram_id -->
        <div id="telegram-id" style="display:none;">{{.TelegramID}}</div>
    </div>
    
    <script>
        const telegramID = document.getElementById("telegram-id").textContent;

        async function fetchTopPlayers() {
            const res = await fetch("/slots/top");
            const players = await res.json();
            const list = document.getElementById("top-list");
            list.innerHTML = "";
            players.forEach(player => {
                const li = document.createElement("li");
                li.textContent = `${player.username}: ${player.total_win.toFixed(2)} USDT`;
                list.appendChild(li);
            });
        }

        async function playGame() {
            const betInput = document.getElementById("bet");
            const bet = parseFloat(betInput.value);
            if (isNaN(bet) || bet < 0.1 || bet > 30) {
                alert("Введите корректную ставку (0.1-30)");
                return;
            }
            const fsMode = document.getElementById("fs_mode").checked;
            const response = await fetch("/slots/play", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegram_id: telegramID, bet: bet, mode: fsMode ? "fs" : "normal" })
            });
            const data = await response.json();
            document.getElementById("balance").textContent = data.new_balance.toFixed(2);
            document.getElementById("freespins").textContent = data.free_spins;
            const reelsDiv = document.getElementById("reels");
            reelsDiv.innerHTML = "";
            data.reels.forEach(symbol => {
                const reelDiv = document.createElement("div");
                reelDiv.className = "reel";
                reelDiv.textContent = symbol;
                reelsDiv.appendChild(reelDiv);
            });
            let resultText = "";
            if (data.message === "loss") {
                resultText = `Вы проиграли ставку ${bet} JPC.`;
            } else if (data.message === "freespin") {
                resultText = `Вы выиграли повтороный спин! Теперь у вас ${data.free_spins} бесплатных вращений.`;
            } else if (data.message === "jackpot") {
                resultText = `Джекпот! Вы выиграли ${data.win_amount.toFixed(2)} JPC. ${data.jackpot_text}`;
            } else {
                resultText = `Вы выиграли ${data.win_amount.toFixed(2)} JPC (тип: ${data.message}).`;
            }
            document.getElementById("result").textContent = resultText;
            fetchTopPlayers();
        }

        document.getElementById("spin").addEventListener("click", playGame);
        fetchTopPlayers();
    </script>
</body>
</html>
